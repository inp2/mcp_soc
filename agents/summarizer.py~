import pandas as pd
from fpdf import FPDF
from transformers import pipeline
from threading import Thread
import pandas as pd
from transformers import pipeline

def summarize_dataset(df,
                      model_name="sshleifer/distilbart-cnn-12-6",
                      max_input_chars=4000,
                      max_tokens=256):
    """
    Safe summarizer for Zeek/Corelight data.
    Explicitly limits input and output length to prevent overflow warnings.
    """

    if df.empty:
        return "No data available to summarize.", {}

    stats = {
        "rows": len(df),
        "columns": len(df.columns),
        "unique_src": df.get("id.orig_h", pd.Series()).nunique(),
        "unique_dst": df.get("id.resp_h", pd.Series()).nunique(),
        "event_types": df["_path"].value_counts().to_dict() if "_path" in df else {},
    }

    # prepare small text sample
    sample_text = df.head(100).to_csv(index=False)
    text = (
        "Summarize the following Zeek/Corelight logs. "
        "Describe event types, anomalies, and security relevance.\n\n"
        f"{sample_text}"
    )

    # limit to safe number of characters (~4 chars per token)
    text = text[:max_input_chars]

    # initialize summarizer
    summarizer = pipeline("summarization", model=model_name, framework="pt")

    # explicit truncation & token bounds
    summary = summarizer(
        text,
        truncation=True,
        max_length=max_tokens,
        max_new_tokens=max_tokens,
        min_length=60,
        do_sample=False,
    )[0]["summary_text"]

    return summary, stats

def generate_pdf_report(summary_text, stats, output_path="store/soc_summary.pdf"):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", "B", 16)
    pdf.cell(0, 10, "MCP-SOC Incident Summary Report", ln=True, align="C")
    pdf.ln(10)

    pdf.set_font("Arial", size=12)
    pdf.multi_cell(0, 8, "Key Statistics:")
    for k, v in stats.items():
        pdf.cell(0, 8, f"â€¢ {k}: {v}", ln=True)

    pdf.ln(10)
    pdf.multi_cell(0, 8, "Summary of Findings:")
    pdf.set_font("Arial", size=11)
    pdf.multi_cell(0, 8, summary_text)
    pdf.output(output_path)
    return output_path
